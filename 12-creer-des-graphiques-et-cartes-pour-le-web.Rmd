# Créer des cartes pour le web {#creer-des-graphiques-et-cartes-pour-le-web}

## Les cartes Leaflet

[`{leaflet}`](https://leafletjs.com/) est une bibliothèque javascript de cartographie en ligne. 
R permet de produire des cartes en exploitant cette bibliothèque.

La limitation de `{leaflet}` est qu'il ne permet de visualiser que des données en projection WGS84.

Dans ce chapitre, nous utiliserons les packages suivants
```{r pkg_chap_15_carto_web, message=FALSE, warning=FALSE}
library(leaflet)
library(sf)
library(tidyverse)
library(COGiter)
library(htmltools)
library(htmlwidgets)
```

Les données utilisées sont issues de `{COGiter}`.

### Carte choroplète

Ci-dessous un exemple avancé de carte choroplète avec leaflet.

- Définition des données de départ

```{r}
pop2015_dep_geo <- pop2015 %>% 
  # mise à jour du COG et agrégation à l'échelle départementale
  cogifier(code_commune = DEPCOM, communes = FALSE, epci = FALSE, departements = TRUE, regions = FALSE, metro = FALSE) %>% 
  inner_join(COGiter::departements_geo, ., by = c("DEP" = "CodeZone")) %>% 
  mutate(densite = pop2015 / as.numeric(AREA) * 1000000) %>% 
  filter(substr(DEP, 1, 2) != "97")

glimpse(pop2015_dep_geo)
```

- Transformation de la projection car `leaflet` ne connait que le WGS 84

```{r}
pop2015_dep_geo <- st_transform(pop2015_dep_geo, crs=("+proj=longlat +datum=WGS84 +no_defs"))
```

- Discrétisation de la variable d'intérêt

```{r}
bornes <- quantile(pop2015_dep_geo$densite, na.rm = TRUE)
```

- Création d'une palette de couleurs associée

`{leaflet}` intègre une fonction `colorBin()` qui permet d'associer à un vecteur de valeurs numériques un vecteur de couleurs en fonction d'une palette et d'un vecteur de bornes.

```{r}
pal <- colorBin("YlOrRd", domain = pop2015_dep_geo$densite, bins = bornes)
```

- Création d'étiquettes popover, à afficher en surbrillance au passage de la souris sur la carte.

```{r}
popover <- sprintf("<strong>%s</strong><br/>%.1f habitants par km² en 2015", 
                   pop2015_dep_geo$Zone, pop2015_dep_geo$densite) %>% 
  lapply(htmltools::HTML)
```

- Réalisation de la carte

La fonction `addPolygons()` permet de créer la carte choroplète.

La fonction `addProviderTiles()` permet de rajouter un fond cartographique parmis les couches fournies par `leaflet`.

```{r, fig.width=7, fig.height=4}
leaflet(pop2015_dep_geo) %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addPolygons(data = pop2015_dep_geo,
              fillColor = ~pal(densite),
              weight = 2,
              opacity = 1,
              color = "white",
              dashArray = "3",
              fillOpacity = 0.7,
              highlight = highlightOptions(
                weight = 5,
                color = "#666",
                dashArray = "",
                fillOpacity = 0.7,
                bringToFront = TRUE),
              label = popover,
              labelOptions = labelOptions(
                style = list("font-weight" = "normal", padding = "3px 8px"),
                textsize = "15px",
                direction = "auto"))
```

### Carte à ronds proportionnels

Pour réaliser des ronds proportionnels, il va faut partir des centroïdes de nos polygones. 
On cherche cette fois à représenter les populations 2015. 

- Création de la table en entrée 

```{r}
dep_centr <- st_centroid(pop2015_dep_geo)
```
- Discrétisation de la variable d'intérêt

```{r}
bornes <- quantile(dep_centr$pop2015 / 1000, na.rm = TRUE)
```

- Création d'une palette de couleurs associée

```{r}
pal <- colorBin("YlOrRd", domain = dep_centr$pop2015 / 1000, bins = bornes)
```

- Création d'un label ad-hoc à afficher en surbrillance au passage de la souris sur la carte.

```{r}
popover <- sprintf("<strong>%s</strong><br/>%.1f milliers habitants en 2015", 
                  dep_centr$Zone, dep_centr$pop2015 / 1000) %>% 
  lapply(htmltools::HTML)
```

- Création de la carte

```{r, fig.width=7, fig.height=4}
carte_rond_proportionnel <- leaflet(dep_centr) %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addCircles(data = dep_centr,
             fillColor = ~pal(pop2015 / 1000),
             radius = ~2500*log(pop2015),
             weight = 2,
             opacity = 1,
             color = "gray",
             dashArray = "3",
             fillOpacity = 0.6,
             highlight = highlightOptions(
               weight = 5,
               color = "#666",
               dashArray = "",
               fillOpacity = 0.98,
               bringToFront = TRUE),
             label = popover,
             labelOptions = labelOptions(
               style = list("font-weight" = "normal", padding = "3px 8px"),
               textsize = "15px",
               direction = "auto")) %>% 
  addLegend("bottomright", pal = pal, values = ~pop2015,
            title = "Nombre d'habitants en 2015 - INSEE - RP",
            opacity = 1)

carte_rond_proportionnel
```

<!-- ## ggplot et ggiraph : TODO -->

<!-- ## Mapfactory : TODO -->


## Les cartes ggplot
TODO

## Les cartes mapfactory
TODO 

## Exporter une sortie html

La fonction `saveWidget()` permet d'exporter une sortie d'un `HTML Widget` en fichier HTML.

```{r, eval=FALSE}
saveWidget(widget = carte_rond_proportionnel, file="Taux de décès des mères à la naissance.html")
```
